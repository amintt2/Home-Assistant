blueprint:
  name: Thermostat intelligent ON/OFF (météo, modes, boost, présence)
  description: >
    Thermostat avancé ON/OFF avec : confort/eco/nuit/absent, boost manuel,
    compensation climatique via météo, auto-absence, hystérésis et 
    déclenchement toutes les 30 secondes.
  domain: automation

  input:
    temp_sensor:
      name: Capteur température intérieure
      selector:
        entity:
          domain: sensor

    heater_switch:
      name: Switch radiateur
      selector:
        entity:
          domain: switch

    weather_entity:
      name: Entité météo Home Assistant
      selector:
        entity:
          domain: weather

    presence_tracker:
      name: Tracker téléphone
      selector:
        entity:
          domain: device_tracker

    home_zone:
      name: Zone Maison
      selector:
        entity:
          domain: zone

    mode_select:
      name: Sélecteur de mode chauffage
      description: "Doit contenir : confort, eco, nuit, absent"
      selector:
        entity:
          domain: input_select

    boost_button:
      name: Bouton Boost (input_boolean)
      selector:
        entity:
          domain: input_boolean

    comfort_temp:
      name: Température Confort
      default: 21
      selector:
        number:
          min: 5
          max: 30
          step: 0.5

    eco_temp:
      name: Température Eco
      default: 19
      selector:
        number:
          min: 5
          max: 30
          step: 0.5

    night_temp:
      name: Température Nuit
      default: 18
      selector:
        number:
          min: 5
          max: 30
          step: 0.5

    away_temp:
      name: Température Absent
      default: 17
      selector:
        number:
          min: 5
          max: 30
          step: 0.5

    boost_temp:
      name: Température Boost
      default: 22.5
      selector:
        number:
          min: 5
          max: 30
          step: 0.5

    outdoor_reference:
      name: Température extérieure de référence
      default: 15
      selector:
        number:
          min: -10
          max: 30
          step: 1

    climate_factor:
      name: Facteur correction climatique
      default: 0.1
      selector:
        number:
          min: 0
          max: 1
          step: 0.01

    hysteresis:
      name: Hystérésis
      default: 0.2
      selector:
        number:
          min: 0
          max: 5
          step: 0.1

mode: single

##########################################################
# TRIGGERS (toutes les 30 secondes)
##########################################################
trigger:
  - platform: time_pattern
    seconds: "/30"

  - platform: state
    entity_id: !input temp_sensor

  - platform: state
    entity_id: !input weather_entity

  - platform: state
    entity_id: !input mode_select

  - platform: state
    entity_id: !input presence_tracker

  - platform: state
    entity_id: !input boost_button

action:

  ##########################################################
  # AUTO-ABSENCE BASÉ SUR PRÉSENCE
  ##########################################################
  - choose:
      - conditions: >
          {{ not is_state(inputs.presence_tracker, "home") }}
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input mode_select
            data:
              option: "absent"

      - conditions: >
          {{ is_state(inputs.presence_tracker, "home") 
             and states[inputs.mode_select].state == "absent" }}
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input mode_select
            data:
              option: "eco"

  ##########################################################
  # VARIABLES POUR LE CALCUL DES CONSIGNES
  ##########################################################
  - variables:
      mode: "{{ states[inputs.mode_select].state }}"
      inside_temp: "{{ states[inputs.temp_sensor].state | float }}"
      outside_temp: "{{ state_attr(inputs.weather_entity, 'temperature') | float }}"
      hys: "{{ inputs.hysteresis | float }}"
      boost: "{{ is_state(inputs.boost_button, 'on') }}"

      base_target: >-
        {% if boost %}
          {{ inputs.boost_temp }}
        {% elif mode == 'confort' %}
          {{ inputs.comfort_temp }}
        {% elif mode == 'eco' %}
          {{ inputs.eco_temp }}
        {% elif mode == 'nuit' %}
          {{ inputs.night_temp }}
        {% else %}
          {{ inputs.away_temp }}
        {% endif %}

      diff: "{{ (inputs.outdoor_reference | float) - outside_temp }}"
      climate_corr: >-
        {% if diff > 0 %}
          {{ diff * (inputs.climate_factor | float) }}
        {% else %}
          0
        {% endif %}

      target_temp: "{{ base_target + climate_corr }}"

  ##########################################################
  # LOG
  ##########################################################
  - service: system_log.write
    data:
      level: info
      message: >
        MODE={{ mode }} | INSIDE={{ inside_temp }} | OUTSIDE={{ outside_temp }} |
        TARGET={{ target_temp }} | BOOST={{ boost }} | HYS={{ hys }}

  ##########################################################
  # COMMANDES AVEC HYSTÉRÉSIS
  ##########################################################
  - choose:
      - conditions: "{{ inside_temp < (target_temp - hys) }}"
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input heater_switch
          - service: system_log.write
            data:
              level: info
              message: "Chauffage ON ({{ inside_temp }} < {{ target_temp }} - {{ hys }})"

      - conditions: "{{ inside_temp > (target_temp + hys) }}"
        sequence:
          - service: switch.turn_off
            target:
              entity_id: !input heater_switch
          - service: system_log.write
            data:
              level: info
              message: "Chauffage OFF ({{ inside_temp }} > {{ target_temp }} + {{ hys }})"
